<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script src="scripts/modernizr.js" type="text/javascript"></script>
    <link href="css/index.css" rel="stylesheet" />


    <link rel='stylesheet prefetch' href='http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css'>
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/chosen.css">
    <script type="text/javascript" src="scripts/jquery.1.5.2.min.js"></script>
    <script src="scripts/index.js"></script>

</head>
<body>




    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header full_with">

                <a class="navbar-brand" href="DashBoard.html">
                    <img id="imgLogo" src="" alt="Logo" style="float:left;" />
                    <span id="lblCompany" style="font-size:x-large" class="loginspan">---</span>
                </a>
                <div class="left_img">
                    <!--<button id="btnLogout" class="logout" type="submit" value="Logout" onclick="return onClick(6);" > <i class="fa fa-sign-out fa-2x"> </i> </button>-->
                    <ul class="menu_login">
                        <li>
                            <button class="logout">
                                <i class="fa fa-bars fa-2x"></i>
                            </button>
                            <ul class="submenu_login">
                                <li>
                                    <a href="UserProfile.html">
                                        <i class="fa fa-user"></i>
                                        User Profile
                                    </a>
                                </li>
                                <li>
                                    <a href="ChangePassword.html">
                                        <i class="fa fa-exchange"></i>

                                        Change  Password
                                    </a>
                                </li>
                                <li>
                                    <a href="#" onclick="return Logout();">
                                        <i class="fa fa-sign-out"></i>
                                        Log Out
                                    </a>
                                </li>

                            </ul>
                        </li>
                    </ul>

                </div>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <!-- /.navbar-collapse -->

        </div><!-- /.container-fluid -->
    </nav>



    <div class="container-fluid ">


        <div class="row">
            <div class="col-md-2 col-sm-2"></div>
            <div class="col-md-8 col-sm-8">
                <form class="form-horizontal" role="form">

                    <div class="form-group">
                        <h2 style="text-align:center;color:#fff;background-color:#0d7192;border-top:double; padding:8px 0; margin:0;border-bottom:double;border-left:double;border-right:double;">
                            <i class="fa  pull-left" style="margin-left:9px;">% </i>
                            Cess
                            <a href="DashBoard.html">
                                <i class="fa fa-times-circle fa-1x pull-right" style="margin-right:9px; cursor:pointer; color:#fff!important;"> </i>
                            </a>
                        </h2>

                    </div>
                    <!--<div class="form-group">
                        <label class="control-label col-sm-6  col-xs-5" for="repwd"> Sub-County: </label>

                        <div class="col-sm-6  col-xs-7">

                            <select id="ddlSubCounty" class="form-control span6 chzn-select" onchange="return itemChange(1);"></select>
                        </div>
                    </div>-->
                    <div class="form-group">
                        <label class="control-label col-sm-6  col-xs-5" for="repwd"> Item Code: </label>

                        <div class="col-sm-6  col-xs-7">

                            <select id="ddlItemCode" class="form-control span6 chzn-select" onchange="return itemChange(1);"></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-6  col-xs-5" for="repwd"> Item Name: </label>
                        <div class="col-sm-6 col-xs-7">

                            <select id="ddlItem" class="form-control span6 chzn-select" onchange="return itemChange(2);"></select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="control-label col-sm-6  col-xs-5" for="repwd"> Amount: </label>
                        <div class="col-sm-6 col-xs-7">
                            <label class="control-label col-sm-6 col-xs-7" for="cpwd" id="lblAmount">0.00</label><br />
                            <label class="control-label col-sm-6 col-xs-7" for="cpwd" id="lblUnits" style="font-size:10px!important;width:100%!important" ></label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-6 col-xs-5" for="cpwd">Qty:</label>

                        <div class="col-sm-6  col-xs-4">
                            <input id="txtQty" class="form-control" type="text" onkeydown="return txtboxPress(this,event,false)" />
                        </div>

                        <div class="col-sm-3 col-xs-3 ">
                            <button type="button" id="btnAdd" onclick="return Add()" class="btn btn-cess pull-right"><span><i class=" icon-plus"></i>&nbsp;Add</span></button>
                        </div>
                    </div>
                    <div class="form-group">
                        <table id="tblAddItem" class="table table-bordered"  >
                           <tr>
                                <th width="25%"><b>Description</b></th>
                                <th width="10%"><b>Qty</b></th>
                                <th width="15%"><strong>Total</strong></th>
                                <th width="10%"><b>X</b></th>
                            </tr>
                          
                        </table>
                        </div>
                    <div class="form-group">
                        <label class="control-label col-sm-6  col-xs-5" for="newpwd">  Total:</label>
                        <div class="col-sm-6  col-xs-7">
                            <input id="txtTotal" class="form-control" type="text" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-6  col-xs-5" for="newpwd">  Mobile No.:</label>
                        <div class="col-sm-6  col-xs-7">
                            <div class="form-control">
                                <span style="display:inline-block;float:left">254</span>
                                <input id="txtMobileNo1" style="display:inline-block!important;float:left" onkeydown="return txtboxPress(this,event,false)" type="text" onblur="return  MobilePaymentValidation(1);" />
                            </div>
                        </div>
                    </div>


                        <div class="form-group">
                            <label class="control-label col-sm-6  col-xs-5" for="repwd"> Pay Mode: </label>
                            <div class="col-sm-6  col-xs-7">
                                <select id="ddlPayMode" class="form-control" onchange="return paymodeChange();">  </select>

                            </div>
                        </div>
                    <!-- 1stpayment -->
                    <div id="divCreditCard" style="display:none">

                        <div class="form-group">
                            <div class="col-sm-6 col-xs-12 "> </div>
                            <div class="col-sm-6 col-xs-12 ">
                                <h4 class="caher" style="text-align:center;">Credit Card </h4>
                            </div>
                            <label style="padding-top:5px;" class="control-label col-sm-6 col-xs-5" for="repwd"> Card No: </label>
                            <div style="padding-top:5px;"  class="col-sm-6 col-xs-7"><input id="txtCardNo1" type="text" disabled="disabled" class="form-control" /><input id="txtCardNo2" type="text" disabled="disabled" class="form-control" /><input id="txtCardNo3" type="text" disabled="disabled" class="form-control" /><input id="txtCardNo4" type="text" disabled="disabled" class="form-control" /></div>
                            <label style="padding-top:5px;" class="control-label col-sm-6 col-xs-5" for="repwd"> Bank Name: </label>
                            <div style="padding-top:5px;" class="col-sm-6 col-xs-7"><input id="txtBankName" type="text" disabled="disabled" class="form-control" /></div>
                            <label style="padding-top:5px;"  class="control-label col-sm-6 col-xs-5" for="repwd"> Trans.No.: </label>
                            <div style="padding-top:5px;"  class="col-sm-6 col-xs-7"><input id="txtTransNo" type="text" onchange="return cashChange1();" onkeyup="return cashChange();" class="form-control" /></div>
                            <label style="padding-top:5px;" class="control-label col-sm-6 col-xs-5" for="repwd"> Holder Name: </label>
                            <div style="padding-top:5px;"  class="col-sm-6 col-xs-7"><input id="txtHolderName" type="text" disabled="disabled" class="form-control" /></div>
                            <label style="padding-top:5px;" class="control-label col-sm-6 col-xs-5" for="repwd"> PDQ.No.: </label>
                            <div style="padding-top:5px;"  class="col-sm-6 col-xs-7"><select id="ddlPdqNo" class="form-control">  </select></div>

                        </div>
                    </div>
                        <!-- 2stpayment -->
                        <div id="div1" style="display:none">

                            <div class="form-group">
                                <div class="col-sm-6 col-xs-12 "> </div>
                                <div class="col-sm-6 col-xs-12 ">
                                    <h4 class="caher" style="text-align:center;">Cash</h4>
                                </div>
                                <!--<label class="control-label col-sm-6 col-xs-5" for="repwd"> Total: </label>
                                <div class="col-sm-6 col-xs-7"><input id="txtTotal" type="text" disabled="disabled" class="form-control" /></div>-->
                                <label style="padding-top:5px;"  class="control-label col-sm-6 col-xs-5" for="repwd"> Cash: </label>
                                <div style="padding-top:5px;"  class="col-sm-6 col-xs-7"><input id="txtCash" onkeydown="return txtboxPress(this,event,false)" type="text" onchange="return cashChange1();" onkeyup="return cashChange();" class="form-control" /></div>
                                <label style="padding-top:5px;" class="control-label col-sm-6 col-xs-5" for="repwd"> Change: </label>
                                <div style="padding-top:5px;"  class="col-sm-6 col-xs-7"><input id="txtChange" type="text" disabled="disabled" class="form-control" /></div>
                            </div>
                        </div>
                        <!-- 3ndpayment -->

                        <div id="div2" style="display:none">

                            <div class="form-group">
                                <div class="col-sm-6 col-xs-12 "> </div>
                                <div class="col-sm-6 col-xs-12 "> <h4 class="caher" style="text-align:center;">M-Pesa</h4></div>
                                <label style="padding-top:5px;"  class="control-label col-sm-6 col-xs-5" for="repwd"> Name: </label>
                                <div style="padding-top:5px;"  class="col-sm-6 col-xs-7"> <input id="txtName" type="text" class="form-control" readonly="readonly" />   </div>
                                <label style="padding-top:5px;"  class="control-label col-sm-6 col-xs-5" for="repwd"> Mobile No.: </label>

                                <div class="col-sm-6 col-xs-7" style="padding-top:5px;">
                                    <div class="form-control">
                                        <span style="display:inline-block;float:left">254</span>
                                        <input id="txtMobileNo" onkeydown="return txtboxPress(this,event,false)" onkeypress="return txtboxPress(this,event,false)" type="text" onblur="    return MobilePaymentValidation(2);" />
                                    </div>
                                </div>   
                                     <label style="padding-top:5px;" class="control-label col-sm-6 col-xs-5" for="repwd"> Ref. No.: </label>
                                <div style="padding-top:5px;"  class="col-sm-6 col-xs-7">
                                    <select id="txtRefNo" class="form-control span6 chzn-select" onchange="return displaydetails();"></select>
                                </div>
                                <label  class="control-label col-sm-6 col-xs-5" for="repwd" id="lblTransDetails" style="width:300px"></label>
                                <label class="control-label col-sm-6 col-xs-5" for="repwd" id="lblPaidFor" style="width:300px"></label>

                            </div>
                        </div>


                        <div class="form-group">
                            <div class=" col-sm-8 col-xs-12 col-sm-offset-4 ">
                                <div class="btnholder  pull-right">
                                    <button class="butsave btn btn-default" onclick="return validateForm()" type="button"><i class="fa fa-floppy-o">&nbsp; </i><span>Save</span></button>

                                    <button class="butcan btn btn-default" id="btnCancel" type="submit" value="Cancel" onclick="return clearAll()" aria-hidden="true" data-dismiss="modal">  <i class="fa fa-times-circle-o">&nbsp; </i>   <span>Cancel</span></button>
                                    <a href="DashBoard.html" class="butsub btn btn-default">
                                        <!--<button class="butsub btn btn-default" onclick="return Close();" aria-hidden="true" data-dismiss="modal" type="button">-->
                                        <i class=" fa fa-hand-o-left"></i><span>&nbsp;Back</span>
                                        <!--</button>-->
                                    </a>
                                </div>
                                <label id="lblErr" style="color:red">  </label>
                            </div>
                            <!--<div class=" col-sm-4 col-xs-4">
                <div class="btnholder  pull-right">



                </div>
            </div>
            <div class="col-sm-4 col-xs-4">
                <div class="btnholder">




                </div>

            </div>-->
                        </div>
</form>
            </div>
            <div class="col-md-2 col-sm-2"></div>
        </div>


    </div>
    <script type="text/javascript" src="scripts/jquery.1.5.2.min.js"></script>
    <script type="text/javascript" src="scripts/jquery.1.5.2.min.js"></script>
    <script src="scripts/jquery.alphanum.js"></script>
    <script src="scripts/jquery.jsonp-2.4.0.min.js"></script>
    <script type="text/javascript">

        //var ip = "http://109.73.172.90:8031/";
       // var ip = "http://localhost:8000/";
        var ip = IPStr();

        var reLogin = "0", forceLogout = "0", t = 0;

        window.onload = fillItems();
        $("#txtNo").alphanum();//you can add any specific characters need to check site jquery.alphanum.js
        $("#txtCash").numeric();//  $("#txtCash").numeric("integer");

        function fillItems() {

            window.timer=  window.setInterval(function () {
                $(getForceLogout).timer();
            }, 1800000);
            //setTimeout(getForceLogout, 200);

            //  localStorage.getItem("lastname");

            //  $("#lblName").text(localStorage.getItem("userName"));


            // fillddl("FeeCollectionService.svc/GetPaymentModes", "ddlPayMode", "ID", "0");


            //FillRegion();
            FillItem();
            var ddl = document.getElementById("ddlPayMode");
            var option0 = document.createElement("option");
            option0.text = " ---Select---";
            option0.value = 0;
            ddl.add(option0, ddl.options[null]);

            var option = document.createElement("option");
            option.text = "Cash";
            option.value = 1;
            ddl.add(option, ddl.options[null]);

            var option1 = document.createElement("option");
            option1.text = "M-Pesa";
            option1.value = 5;
            ddl.add(option1, ddl.options[null]);

            //var option2 = document.createElement("option");
            //option2.text = "Both";
            //option2.value = 15;
            //ddl.add(option2, ddl.options[null]);
            getReLogin("FeeCollectionService.svc/POSRelogin", "?formType=P");

            clearAll();
            attachChosen();
        }

        function FillRegion() {
            fillddl("FeeCollectionService.svc/GetddlRegion", "ddlRegion", "ID", "-1");
        }

        function FillItem() {
            fillddl("FeeCollectionService.svc/GetCessItems?RegionID=" + localStorage.getItem("RegionID"), "ddlItem", "IDStr", "Name", "0:0.00:-");
            fillddl("FeeCollectionService.svc/GetCessItems?RegionID=" + localStorage.getItem("RegionID"), "ddlItemCode", "IDStr", "Code", "0:0.00:-");
           
        }

        function Add() {
            if ($("#ddlItem").val().trim() == "0:0.00:-") {
                $("#lblErr").text("Please select the Item "); EnableSave();
                $("#ddlItem").focus();
                return false;
            }
            else if ($("#txtQty").val().trim() == "") {
                $("#lblErr").text("Please enter the Quantity"); EnableSave();
                $("#txtQty").focus();
                return false;
            }


            if (isNaN($("#txtQty").val().trim()) ) {
                $("#lblErr").text("Quantity has to be numeric"); EnableSave();
                $("#txtQty").focus();
                return false;
            }

            if (parseFloat($("#txtQty").val().trim()) <= 0) {
                $("#lblErr").text("Quantity Cannot be Lesser than or Equal to Zero"); EnableSave();
                $("#txtQty").focus();
                return false;
            }
            else {
              
                var itemid = $("#ddlItem").val();
                var id = itemid.split(':')[0];
                var itemdesc = $("#ddlItem option:selected").text();
                var quantity = $("#txtQty").val();
                var amount = $("#lblAmount").text();
                var total = parseFloat(parseFloat(quantity) * parseFloat(amount)).toFixed(4);
             
                //try {
                //    if ($("#td_" + itemid).length > 0) {
                //        return false;

                //    }
                //} catch (e) { }
            
                var str = "";
                str = "<tr style='white-space:nowrap; ' id='" + id + "'>";
                //str = "<tr style='white-space:nowrap; '>";
                str = str + "<td id='td_" + itemid + "' ><label id='ItemId' text='" + itemid + "' value='" + itemid + "' />" + itemdesc + "</td>";
                str = str + "<td>" + quantity + "</td>";
                str = str + "<td>" + total + "</td>";
                str = str + "<td><input type=button value=del  id='btndelete_" + itemid + "' class='btnDelete' onclick='return DeleteItem(this)' /></td>";
                str = str + "</tr>";
                $("#tblAddItem tbody").append(str);
               // $("#ddlItem option:selected").remove();
               

                ClearAdd();
               // CheckForMandatory();

                var tr = $("#tblAddItem tr");
                var TotalAmount = 0;
                var TAmt = 0;
                for (var i = 1; i < tr.length; i++) {
                    TAmt = parseFloat($(tr[i]).find("td:nth-child(3)").text());
                    TotalAmount = (parseFloat(TotalAmount) + parseFloat(TAmt));
                }
                $("#txtTotal").val(TotalAmount.toFixed(4));
                if ($("#txtmobile").val().trim() != "")
                {
                    MobilePaymentValidation();
                }
            }
            return false;
        }

        function DeleteItem(btn) {
            var itemid = $(btn).attr("id").split('_')[1];
            var res = confirm("Do you wish to Delete this Item ?");
            if (res == true) {
                $(btn).parent().parent().remove();
    
              //  $("#ddlItem").append("<option value='" + itemid + "'>" + $("#ddlItem option:selected").text() + "</option>");

                var tr = $("#tblAddItem tr");
                var TotalAmount = 0;
                var TAmt = 0;
                for (var i = 1; i < tr.length; i++) {
                    TAmt = parseFloat($(tr[i]).find("td:nth-child(3)").text());
                    TotalAmount = (TotalAmount + TAmt);
                }
                $("#txtTotal").val(TotalAmount.toFixed(4));
                if ($("#txtmobile").val().trim() != "")
                {
                    MobilePaymentValidation();
                }
            }
            return false;
        }

        function ClearAdd() {
            //GetddlItem();
            $("#ddlItemCode").val("0:0.00:-");
            $("#ddlItem").val("0:0.00:-");
            $("#txtQty").val("");
            $("#lblUnits").text("");
            $("#lblAmount").text("0.00");
            $("#ddlItem").trigger("liszt:updated");
            $("#ddlItemCode").trigger("liszt:updated");
            $("#ddlRegion").trigger("liszt:updated");
            $("#lblErr").text("");
        }


        //function FillSubCounty() {
        //    fillddl("FeeCollectionService.svc/GetddlSubCounty", "ddlSubCounty", "ID", "-1");
        //}

        function MobilePaymentValidation(i)
        {
            if (i == 1) {
                GetCitizenName();
                //if(  $("#txtMobileNo1").val().trim() != "" && $("#txtMobileNo1").val().trim().length >9)
                //    fillddl("FeeCollectionService.svc/MobilePaymentValidation?PhoneNo=" + $("#txtMobileNo1").val() + "&Amount=" + $("#txtAmt").val(), "txtRefNo", "ID", "-1");
                return false;
            }
            $("#txtName").val("");
            $("#txtRefNo").html("<option value='-1'> ---SELECT---</option>");
            try {
                $("#txtRefNo").trigger("liszt:updated");
            } catch (x) { }

            if (isNaN($("#txtMobileNo").val().trim())) {
                $("#txtMobileNo").val("");
                return false;
            }

            if ($("#txtMobileNo").val().trim().substr(0, 1) == "0") {
                $("#txtMobileNo").val($("#txtMobileNo").val().trim().substr(1, $("#txtMobileNo").val().trim().length - 1));
            }


            if ($("#txtMobileNo").val().trim() != "" && $("#txtMobileNo").val().trim().length > 6)
                fillddl("FeeCollectionService.svc/MobilePaymentValidation?PhoneNo=" + $("#txtMobileNo").val() + "&Amount=" + $("#txtTotal").val() + "&TransCode=", "txtRefNo", "ID","Name", "-1");
         
            return false;
        }

        function displaydetails()
        {
            var ddl = document.getElementById("txtRefNo");
            var option = ddl.options.item(ddl.selectedIndex);
            var arr = option.value.split(":");
            $("#lblTransDetails").text("Name: " + arr[0] );
            $("#lblPaidFor").text( " Paid For: " + arr[1]);

        }

        function fillddl(serviceFunc, ddlControl, valueFld, displayFld, defaultValue) {
            // alert(ip + serviceFunc);
            $.support.cors = true;
            $.ajax({
                type: "GET",
                url: ip + serviceFunc,
                success: function (result) {
                    if (result != null) {

                        var res = result.d;
                        var ddl = document.getElementById(ddlControl);

                        $('#' + ddlControl).empty();

                        if (valueFld == "ID") {

                            for (var i = 0; i < res.length; i++) {
                               var option = document.createElement("option");
                                if (i == 0) {
                                    option.text = res[0].Name;
                                    option.value = res[0].IDStr;
                                    ddl.add(option, ddl.options[null]);
                                } else {
                                    if (displayFld == "Name")
                                        option.text = res[i].Name.split(':')[0];
                                    else
                                        option.text = res[i].Name.split(':')[1];
                                    option.value = res[i].ID;
                                    ddl.add(option, ddl.options[null]);

                                }
                            }
                        }
                        else {


                            for (var i = 0; i < res.length; i++) {



                                var option = document.createElement("option");
                                if (i == 0) {
                                    option.text = res[0].Name;
                                    option.value = res[0].IDStr;
                                    ddl.add(option, ddl.options[null]);
                                } else {
                                    if (displayFld == "Name")
                                        option.text = res[i].Name.split(':')[0];
                                    else
                                        option.text = res[i].Name.split(':')[1];
                                    option.value = res[i].IDStr;
                                    ddl.add(option, ddl.options[null]);

                                }
                            }
                        }

                    }

                },

                dataType: "json",
                error: function (request, status, exception) {
                    alert(status + '  ' + request.responseText);
                },
                complete: function (request, status) { $("#" + ddlControl).val(defaultValue); $("#" + ddlControl).focus(); $("#" + ddlControl).chosen(); $("#" + ddlControl).trigger("liszt:updated"); }
            });

            //alert("end");
        }

        function getValue(serviceFunc) {
            var len1;
            $.support.cors = true;

            $.ajax({
                type: "GET",
                dataType: "json",
                url: ip + serviceFunc,
                success: function (result) {
                    if (result != null) {

                        var res = result.d;
                        len1 = res.length;

                    }

                }
            });

            return len1;
        }

        function getReLogin(serviceFunc, Param) {
            $.support.cors = true;
            $.ajax({
                type: "GET",
                url: ip + serviceFunc + Param,
                dataType: "json",
                success: function (result) {
                    if (result != null) {
                        reLogin = result.d;
                    }
                },
                error: function (request, status, exception) {
                    alert(exception + '  ' + " Error");
                },
                complete: function (request, status) { }
            });


        }

        function getForceLogout(serviceFunc, Param) {
            $.support.cors = true;
            $.ajax({
                type: "GET",
                url: ip + serviceFunc + Param,
                dataType: "json",
                success: function (result) {
                    if (result != null) {
                        forceLogout = result.d;
                        alert("forceLogout:" + forceLogout);
                    }
                },
                error: function (request, status, exception) {
                    alert(exception + '  ' + " forceLogout Error");
                },
                complete: function (request, status) { }
            });


        }

        function Logout() {

        }

        function itemChange(val) {
            var ddl;
            if (val == 1) {

                ddl = document.getElementById("ddlItemCode");
                $("#ddlItem").val($("#ddlItemCode").val());
            }
            if (val == 2) {
                ddl = document.getElementById("ddlItem");
                $("#ddlItemCode").val($("#ddlItem").val());
            }


            $("#ddlItemCode").trigger("liszt:updated");
            $("#ddlItem").trigger("liszt:updated");

            var option = ddl.options.item(ddl.selectedIndex);
            var arr = option.value.split(":");
            //alert(arr);
            $("#lblAmount").text(arr[1]);
            $("#lblUnits").text(arr[2]);
            
            $("#txtQty").val("1");
            $("#txtAmt").val(arr[1]);
            $("#txtTotal").val(arr[1]);
        }

        function getAmount() {
            $("#txtAmt").val("");
            $("#txtTotal").val("");
            if ($("#ddlItem").val().split(':')[0] == "-1" || $("#ddlItem").val().split(':')[0] == "0") {
                return false;
            }
            else if ($("#ddlRegion").val() == "-1") {
                return false;
            }

            else {
                $.support.cors = true;
                $.ajax({
                    type: "GET",
                    url: ip + "FeeCollectionService.svc/GetAmount?LineID=" + $("#ddlItem").val().split(':')[0] + "&RegionID=" + $("#ddlRegion").val(),
                    dataType: "json",
                    success: function (result) {
                        if (result != null) {
                            // var Amount = result.d;
                            $("#txtAmt").val(result.d);
                            $("#txtTotal").val(result.d);
                        }
                    },
                    error: function (request, status, exception) {
                        alert(exception + '  ' + request.responseText);
                    },
                    complete: function (request, status) { }
                });

            }

        }

        function GetCitizenName() {

            if (isNaN($("#txtMobileNo1").val().trim())) {
                $("#txtMobileNo1").val("");
                return false;
            }
            if ($("#txtMobileNo1").val().trim().substr(0, 1) == "0") {
                $("#txtMobileNo1").val($("#txtMobileNo1").val().trim().substr(1, $("#txtMobileNo1").val().trim().length - 1));
            }
            if ($("#txtMobileNo1").val().trim() != "")
            {
            $.support.cors = true;
            $.ajax({
                type: "GET",
                url: ip + "FeeCollectionService.svc/GetCitizenName?MobileNo=254" + $("#txtMobileNo1").val(),
                dataType: "json",
                success: function (result) {
                    if (result != null) {
                        // var Amount = result.d;
                        $("#txtName").val(result.d);
                        if($("#txtMobileNo").val()=="")
                            $("#txtMobileNo").val($("#txtMobileNo1").val());

                        $("#lblErr").text("");
                    }
                },
                error: function (request, status, exception) {
                    //alert(exception + '  ' + request.responseText);
                    $("#lblErr").text("Invalid Mobile No. !!!");
                   // $("#txtMobileNo1").select().focus();
                },
                completed: function () {
                    if($("#lblErr").length==0)
                        fillddl("FeeCollectionService.svc/MobilePaymentValidation?PhoneNo=254" + $("#txtMobileNo").val() + "&Amount=" + $("#txtAmt").val() + "&TransCode=", "txtRefNo", "ID", "Name", "-1");
                }
            });
            }

            return false;
        }

        function paymodeChange() {
            var ddl = document.getElementById("ddlPayMode");
            var option = ddl.options.item(ddl.selectedIndex);
            // alert(option.value);
            if (option.value == "0") { $("#div1").attr("style", "display:none"); $("#div2").attr("style", "display:none"); $("#ddlPayMode").select().focus(); }
            else if (option.value == "1") { $("#div1").attr("style", "display:''"); $("#div2").attr("style", "display:none"); $("#txtCash").select().focus(); }
            else if (option.value == "2") { $("#divCreditCard").attr("style", "display:''"); $("#div1").attr("style", "display:none"); $("#div2").attr("style", "display:none");}
            else if (option.value == "5") { $("#div1").attr("style", "display:none"); $("#div2").attr("style", "display:''"); $("#txtName").select().focus(); }
            else if (option.value == "15") { $("#div1").attr("style", "display:''"); $("#div2").attr("style", "display:''"); $("#txtName").select().focus(); }
            else {
                $("#ddlPayMode").val("1");
                $("#div1").attr("style", "display:''"); $("#div2").attr("style", "display:none");
                $("#txtCash").select().focus();
            }
            //alert(arr[1]);

        }

        function cashChange() {
            if ($("#txtCash").val().trim() != "") {
                if (isNaN($("#txtCash").val().trim())) $("#txtCash").val("0.00");
                $("#txtChange").val(parseFloat($("#txtCash").val() - $("#txtTotal").val()).toFixed("2"));
            }
            else {
                $("#txtChange").val("0.00");
            }
        }

        function cashChange1() {
            if ($("#txtCash").val().trim() != "") {


                if (isNaN($("#txtCash").val().trim())) $("#txtCash").val("0.00");
                $("#txtCash").val(parseFloat($("#txtCash").val()).toFixed("2"));
                //  $("#txtChange").val(parseFloat($("#txtCash").val() - $("#txtTotal").val()).toFixed("2"));
                if ($("#ddlPayMode").val() != "15") {
                    if (parseFloat($("#txtChange").val()) < 0)
                    { $("#lblErr").text("Invalid Amount !!!"); $("#txtCash").focus(); }
                    else { $("#lblErr").text(""); $("#btnSave").focus(); }
                }
            }

        }


        function sendSMS(receiptId) {
            var obj = new Object();
            obj.username = "Konvergenz";
            obj.apiKey = "4dm1n2015sd0343994dsmdnw23";
            obj.msisdn ="254" +$("#txtMobileNo").val();
            obj.body = "Received with thanks from 254" + $("#txtMobileNo").val() + "\n Amount:" + $("#txtTotal").val();
            obj.msgID = receiptId;
            obj.accountID = "234";

            //$.support.cors = true;

            //The ommented post also works fine
            //$.post("http://outreach.elasticbeanstalk.com/sms/api/xml",
            // " <smslist><sms><username>Konvergenz</username><apiKey>4dm1n2015sd0343994dsmdnw23</apiKey><accountID>234</accountID><msgID>10</msgID><msisdn>254716585843</msisdn> <body>This is the sms body</body><unicode>1</unicode></sms></smslist> ",
            //function (data, status) {
            //    alert("Data: " + data + "\nStatus: " + status);
            //});



            $.ajax({
                dataType: "json",
                type: "POST",
                contentType: "application/json; charset=utf-8",
                url: "http://outreach.elasticbeanstalk.com/sms/api/json",
                data: JSON.stringify(obj),


                success: function (data) {
                    //alert(data.d);
                    alert("Amount Received for Receipt No.:" + receiptId);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert("SMS sent for Receipt No.:" + receiptId);
                    // alert(jqXHR.code + " - " + jqXHR.responseText + " - " + jqXHR.responseJSON);
                }
            });

        }


        function validateForm() {
            $("#lblErr").text("");
            if ($("#txtMobileNo1").val().trim() == '') { $("#lblErr").text("Please enter Mobile No. !!!"); $("#txtMobileNo1").select().focus(); return false; }
            if ($("#txtName").val() == '') { $("#lblErr").text("Please enter valid Mobile No. !!!"); $("#txtMobileNo1").select().focus(); return false; }

            //if ($("#ddlItem").val().trim() == "0:0.00:-")
            //{
            //    $("#lblErr").text("Please select the item !!!");
            //    $("#ddlItem").select().focus();
            //    return false;
            //}
            //else 
            if ($("#ddlPayMode").val() == "0") {
                $("#lblErr").text("Please select payment mode !!!");
                $("#ddlPayMode").select().focus();
                return false;
            }
            else if ($("#ddlPayMode").val() == "1") {
                if ((parseFloat($("#txtCash").val()) <= 0 || $("#txtCash").val() == ''))
                {
                    $("#lblErr").text("Please enter Cash-Amount !!!");
                    $("#txtCash").select().focus();
                    return false;
                }
                else if (parseFloat($("#txtChange").val()) < 0)
                {
                    $("#lblErr").text("Invalid Amount !!!");
                    $("#txtCash").focus();
                    return false;
                }
            }
            else if ($("#ddlPayMode").val() == "5") { //($("#ddlPayMode").val() != "1" && $("#ddlPayMode").val() != "0") {
                 if ($("#txtRefNo").val() == '' || $("#txtRefNo").val() == '-1') {
                    $("#lblErr").text("Please select Refference No. !!!");
                    $("#txtRefNo").select().focus();
                    return false;
                }
                 else if ($("#txtMobileNo").val() == '')
                 {
                     $("#lblErr").text("Please enter Mobile No. !!!");
                     $("#txtMobileNo").select().focus();
                     return false;
                 }
            }
            else if ($("#ddlPayMode").val() == "15") {

                if ((parseFloat($("#txtCash").val()) <= 0 || $("#txtCash").val() == ''))
                {
                    $("#lblErr").text("Please enter Cash-Amount !!!");
                    $("#txtCash").select().focus(); return false;
                }
              //  else if (parseFloat($("#txtChange").val()) < 0)
               // { $("#lblErr").text("Invalid Amount !!!"); $("#txtCash").focus(); return false; }

                if ($("#txtRefNo").val() == '' || $("#txtRefNo").val() == '-1')
                {
                    $("#lblErr").text("Please enter Refference No. !!!");
                    $("#txtRefNo").select().focus();
                    return false;
                }
                else if ($("#txtMobileNo").val() == '')
                {
                    $("#lblErr").text("Please enter Mobile No. !!!");
                    $("#txtMobileNo").select().focus();
                    return false;
                }
            }

          //  alert(1);
            CESSDML("FeeCollectionService.svc/TransactionCESSDML");
            
            return true;
          }

        function clearAll() {
            $("#lblErr").text("");
            $("#ddlItem").val("0");
            $("#ddlPayMode").val("0");
            $("#txtCash").val("0.00");
            $("#txtMobileNo1").val("");
            $("#txtMobileNo").val("");
            $("#txtNo").val("");

             $("#lblTransDetails").text("");
             $("#lblPaidFor").text("");

            $("#txtTotal").val("0.00");
            $("#txtCash").val("0.00");
            $("#txtChange").val("0.00");

            $("#txtName").val("");
            $("#txtRefNo").val("-1");
            $("#ddlItem").select().focus();
            $("#tblAddItem tbody").html("<tr><th width='25%'>Description</th><th width='10%'>Qty</th> <th width='15%'>Total</th> <th width='10%'>X</th> </tr>");

            $("#txtAmt").val("0.00");
            $("#ddlItemCode").val("0:0.00:-");
            $("#ddlItem").val("0:0.00:-");
            $("#ddlItemCode").trigger("liszt:updated");
            $("#ddlItem").trigger("liszt:updated");
            $("#txtRefNo").trigger("liszt:updated");
            return false;
        }

        function ReportPrint() {

        }

        function CESSDML(serviceFunc) {

        var obj = new Object();
        obj.ExRate = "1";
        obj.RefType = "2";
        obj.SourceID = "2";

        obj.RevenueStreamID = "5020";
        obj.LineID = $("#ddlItem").val().toString().split(':')[0]
        obj.Amount = $("#txtTotal").val().trim();
        obj.KshAmount = $("#txtTotal").val().trim();

        obj.PaymentModeID = $("#ddlPayMode").val().trim();

        obj.MobileNo ="254"+ $("#txtMobileNo").val().trim();

        obj.MName = $("#txtName").val().trim();
        var ddl = document.getElementById("txtRefNo");
        var option = ddl.options.item(ddl.selectedIndex);
        var arr = option.value.split(":");
       
        obj.MRefNo = arr[3];
        obj.RefNo = arr[3];

        obj.CashTendered = $("#txtCash").val().trim();
        obj.ChangeCash = $("#txtChange").val().trim();

        obj.UserID = localStorage.getItem("UserID");
        obj.FullName = localStorage.getItem("FullName");
        obj.DepartmentID = localStorage.getItem("DepartmentID");
        obj.IP = "1";
        obj.ComputerName = "1";
        obj.ModuleID = "4002";
        obj.CashierID = localStorage.getItem("UserID");
        obj.CounterID = localStorage.getItem("CounterID");
        obj.KshAmount = $("#txtTotal").val().trim();
        obj.USDAmount = "0";
        obj.USDEquvAmount = "0";
        obj.BatchID = "0";
        obj.RegionID = localStorage.getItem("RegionID");
        obj.AreaID = localStorage.getItem("AreaID");
        obj.CollectionAccountID = "9050";
        obj.PDQID = "0";
        obj.BankID = "0";
        obj.BranchID = "0";
        obj.ChequeNo = "";
        obj.CardNo = "";
        obj.TransNo = "";
        obj.HolderName = "";
        obj.RefID = "0";
        obj.IsPenalty = "0";
        var recieptid;
        var str = "";
        var Qty, Amt, TAmt, LineID;
        var tr = $("#tblAddItem tr");
       
        for (var i = 1; i < tr.length; i++)
        {
            LineID = $(tr[i]).attr('id');
            Qty = parseFloat($(tr[i]).find("td:nth-child(2)").text()).toFixed(4);
            TAmt = parseFloat($(tr[i]).find("td:nth-child(3)").text()).toFixed(4);
            Amt = (TAmt / Qty);
            str = str + Qty + ":" + Amt + ":" + TAmt + ":" + LineID + "~";
        }
        obj.SubItems = str;
      
        $.ajax({
            url: ip + serviceFunc,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ objGroup: JSON.stringify(obj) }),
            success: function (data) {

                if (data.d.trim() != "") {
                   
                    recieptid = data.d;
                    var arr = recieptid.split('!');
                    if (arr.length > 1)
                        alert(recieptid);
                    else
                    sendSMS(recieptid);
                       
                }

            },
            error: function (err) {
                alert(err.status+ err.responseText);
            }
              ,
            complete: function (data) { clearAll(); }
        });
        return false;
        }

        function attachChosen() {
            $(".chzn-select").chosen(); $(".chzn-select-deselect").chosen({ allow_single_deselect: true });
        }

        //function MobileSms() {
        //    var obj = "username:'Konvergenz',apiKey:'4dm1n2015sd0343994dsmdnw23', accountID: '234', msgID:'',msisdn:'254725830449',body:'this is the sms body'";
        //    $.ajax({
        //        url: "http://outreach.elasticbeanstalk.com/sms/api/json",
        //        type: "POST",
        //        contentType: "application/json",
        //        data: JSON.stringify({ objGroup: JSON.stringify(obj) }),
        //        success: function (data) {
        //            alert('Receipt sent to : ' + $("#txtMobileNo").val().trim());
        //            //if (data.d.trim() != "") {
        //            //    MessageBox.Show((data.d));
        //            //}
        //            //else {
        //            //    $("#DivSaved").attr("style", "");

        //            //}
        //        },
        //        error: function (err) {
        //            alert(err.status+ err.responseText);
        //        }
        //    });


        //    }

        function Logout() {
            LogOut();
            window.location = "index.html";
        }

    </script>

    <script type="text/javascript">

        window.onload = loadForm();

        function loadForm() {
            $("#lblCompany").text(localStorage.getItem("CompanyName"));
            $("#imgLogo").attr("src", localStorage.getItem("CompanyLogo"));
            $("#txtMobileNo1").css("width", parseInt($("#txtTotal").css("width")) - 30);
            $("#txtMobileNo").css("width", parseInt($("#txtTotal").css("width")) - 30);

        }

        $(window).resize(function () {


            $("#ddlItemCode_chzn").css("width", parseInt($("#txtTotal").css("width")) + 25);
            $("#ddlItem_chzn").css("width", parseInt($("#txtTotal").css("width")) + 25);
            $("#txtMobileNo1").css("width", parseInt($("#txtTotal").css("width")) - 30);
            $("#txtMobileNo").css("width", parseInt($("#txtTotal").css("width")) - 30);
            $("#txtRefNo_chzn").css("width", parseInt($("#txtTotal").css("width")) + 25);



        });
    </script>
    <script src="cordova.js"></script>
    <script src="scripts/platformOverrides.js"></script>
    <script src="scripts/chosen.jquery.min.js"></script>
    <script src="scripts/bootstrap.js"></script>

</body>

</html>